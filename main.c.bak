#include <stdio.h>
#include <stdint.h>
#include <unistd.h>
#include <time.h>
#include <pthread.h>

#include "lvgl/src/display/lv_display.h"
#include "lv_drv_conf.h"
#include "lvgl/lvgl.h"
#include "lvgl/src/drivers/wayland/lv_wayland.h"
#include "lv_drivers/wayland/wayland.h"

#define H_RES (480)
#define V_RES (272)

#define NANOSECOND_TO_MILISECOND_RATE 1000000
#define MICROSECOND_TO_MILISECOND_RATE 1000


#include "lvgl/examples/lv_examples.h"


uint32_t get_milis(){
  struct timespec ts;
  clock_gettime(CLOCK_MONOTONIC, &ts);
  return ts.tv_nsec / NANOSECOND_TO_MILISECOND_RATE;
}

static pthread_t thread1;
static void* tick_thread(void* data);

int main(){

  puts("hello world");

  lv_init();
  lv_wayland_init();

  pthread_create( &thread1, NULL, tick_thread,NULL);
  //lv_tick_set_cb(get_milis);

  /*lv_disp_t * disp = lv_wayland_create_window(H_RES, V_RES, "Hello world", NULL);
  if (disp == NULL){
    puts("Display error!");
    return 1;
  }
*/
  //lv_wayland_window_set_fullscreen(disp,true);
  
  /*Change the active screen's background color*/
  //lv_obj_set_style_bg_color(lv_screen_active(), lv_color_hex(0x003a57), LV_PART_MAIN);

  /*Create a white label, set its text and align it to the center*/
  /*lv_obj_t* label = lv_label_create(lv_screen_active());
  lv_label_set_text(label, "Hello world");
  lv_obj_set_style_text_color(lv_screen_active(), lv_color_hex(0xffffff), LV_PART_MAIN);
  lv_obj_align(label, LV_ALIGN_CENTER, 0, 0); 
*/
lv_example_get_started_1();
//  uint32_t last = get_milis();
  
  int i = 0;
  while(1){
/*    uint32_t now = get_milis();
    uint32_t diff = now - last;
    lv_tick_inc(diff);
    last = now;
*/

    uint32_t time_till_next = lv_wayland_timer_handler();
    printf("%d. sleeping for %d ms\n",i++,time_till_next);
    usleep(time_till_next*MICROSECOND_TO_MILISECOND_RATE ); 
  }


  pthread_join(thread1,NULL);
  lv_wayland_deinit();
  lv_deinit();

  return 0;

}


static void *tick_thread(void* data) {
    (void) data;
    while(1) {
        usleep(5 * 1000);
        lv_tick_inc(5); /*Tell LittelvGL that 5 milliseconds were elapsed*/
    }
}




